<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generaci√≥n y Exportaci√≥n de Reportes</title>
  <link rel="stylesheet" href="reporte.css">
  <!-- Incluimos Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
  <aside class="menu-lateral">
    <h2>Men√∫</h2>
    <nav>
      <ul>
        <li><a href="dashboard.html" ><span>üè†</span> Inicio</a></li>
        <li><a href="reporte.html"  class="active"><span>üìÑ</span> Reportes</a></li>
        <li><a href="incidentes.html"><span>üö®</span> Incidentes</a></li>
        <li><a href="usuarios.html"><span>üë•</span> Usuarios</a></li>
        <li><a href="configuracion.html"><span>‚öôÔ∏è</span> Configuraci√≥n</a></li>
        <li><a href="#" id="cerrar-sesion"><span>üîí</span> Cerrar sesi√≥n</a></li>
        
      </ul>
    </nav>
  </aside>

  <div class="container">
    <header>
      <h1>Generaci√≥n y Exportaci√≥n de Reportes</h1>
      <p>Filtra, exporta y analiza los incidentes para tomar decisiones informadas.</p>
    </header>
    
    <section class="filtros-avanzados">
      <h2>Filtros Avanzados</h2>
      <form id="form-filtros">
        <div class="campo">
          <label for="fecha-inicio">Fecha Inicio:</label>
          <input type="date" id="fecha-inicio" name="fecha-inicio">
        </div>
        <div class="campo">
          <label for="fecha-fin">Fecha Fin:</label>
          <input type="date" id="fecha-fin" name="fecha-fin">
        </div>
        <div class="campo">
          <label for="ubicacion">Ubicaci√≥n:</label>
          <select id="ubicacion" name="ubicacion">
            <option value="">Todas</option>
            <option value="banio1">Ba√±o 1</option>
            <option value="banio2">Ba√±o 2</option>
            <!-- M√°s opciones seg√∫n necesidad -->
          </select>
        </div>
        <div class="campo">
          <label for="estado">Estado:</label>
          <select id="estado" name="estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en-proceso">En Proceso</option>
            <option value="resuelto">Resuelto</option>
          </select>
        </div>
        <button type="submit">Aplicar Filtros</button>
      </form>
    </section>

  <!-- Secci√≥n de Exportaci√≥n de Datos -->
    <section class="exportacion">
      <h2>Exportaci√≥n de Datos</h2>
      <p>Descarga los reportes en formatos CSV o PDF para an√°lisis externos o reuniones.</p>
      <div class="botones-exportacion">
        <button id="export-csv">Exportar CSV</button>
        <button id="export-pdf">Exportar PDF</button>
      </div>
    </section>
    </section>

    <!-- Secci√≥n de Estad√≠sticas Avanzadas -->
    <section class="estadisticas-avanzadas">
      <h2>Estad√≠sticas Avanzadas</h2>
      <p>Visualiza tendencias por hora, d√≠a y ubicaci√≥n, y realiza comparativas entre periodos.</p>
      <div class="graficos">
        <!-- Aqu√≠ insertamos nuestra gr√°fica de barras -->
        <div class="grafico">
          <canvas id="graficaDanios" width="600" height="400"></canvas>
        </div>
        <div class="grafico" id="grafico-comparativo">
          <p>Gr√°fico Comparativo</p>
        </div>
      </div>
    </section>
  </div>
  <script>
    if(!localStorage.getItem('authToken')){
      window.location.href = "login.html"
    }
  </script>

  <!-- Script para generar la gr√°fica con Chart.js -->
  <script>
    inicializarPaguina();

    /**
     * Genera una gr√°fica de barras de reportes por tipo de da√±o.
     * @param {string} canvasId   ‚Äî Id del elemento <canvas>.
     * @param {string[]} tipos     ‚Äî Array con los nombres de cada tipo de da√±o.
     * @param {number[]} cantidades‚Äî Array con la cantidad de reportes correspondiente.
     * @param {string} [titulo]    ‚Äî (Opcional) T√≠tulo de la gr√°fica.
     * @returns {Chart}            ‚Äî Instancia de Chart.js.
     */
    function generarGraficaDanios(canvasId, tipos, cantidades, titulo = 'Reportes por tipo de da√±o') {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: tipos,
          datasets: [{
            label: 'Cantidad de reportes',
            data: cantidades,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: titulo,
              font: { size: 18 }
            },
            legend: { display: false }
          },
          scales: {
            x: {
              title: { display: true, text: 'Tipo de da√±o' },
              ticks: { maxRotation: 45, minRotation: 0 }
            },
            y: {
              title: { display: true, text: 'Cantidad de reportes' },
              beginAtZero: true,
              precision: 0
            }
          }
        }
      });
    }

    async function inicializarPaguina(){
      // Obtener datos de la API o de un array est√°tico
      let datosAPI;
      try {
        datosAPI = await obtenerIncidentesAPI({});
        if (datosAPI == {}) {
          return
        }
      } catch (error) {
        console.error('Error al obtener los datos de la API:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al cargar los datos',
          text: 'No se pudieron obtener los incidentes. Por favor, int√©ntalo de nuevo m√°s tarde.'
        }); 
      }

      // Generar graficas
      try {
        //generarGraficas(datosAPI);
      } catch (error) {
        console.error('Error al generar las gr√°ficas:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al generar las gr√°ficas',
          text: 'No se pudieron generar las gr√°ficas. Por favor, int√©ntalo de nuevo m√°s tarde.'
        });
      }

    }

    async function obtenerIncidentesAPI(filtros = {}){
      const queryParams = new URLSearchParams(filtros).toString();
      const url = `http://localhost:1234/incidentes${queryParams ? '?' + queryParams : ''}`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Error en la solicitud: ' + response.status);
        }
        const temp = await response.json();
        const data = temp.datos
        if (data.length === 0) {
          Swal.fire({
            icon: 'info',
            title: 'No hay datos disponibles',
            text: 'No se encontraron incidentes con los filtros aplicados.'
          });
          return {};
        }
        incidentesAPI = data; // Variable global
        return incidentesAPI;
      } catch (error) {
        console.error('Error al obtener los datos:', error);
        throw error;
      }
    }
    
    // EJEMPLO: datos est√°ticos. C√°mbialos por tu array real o por datos que obtengas v√≠a fetch.
    const tipos = ['Obstrucci√≥n', 'Fugas', 'Vandalismo', 'Mantenimiento'];
    const cantidades = [12, 7, 5, 3];

    // Al cargar la p√°gina, generamos la gr√°fica
    window.addEventListener('DOMContentLoaded', () => {
      generarGraficaDanios('graficaDanios', tipos, cantidades);
    });

    // Funcion para exportar a PDF
    function exportarPDF() {
      // Aqu√≠ ir√≠a la l√≥gica para exportar a PDF
      alert('Funci√≥n de exportaci√≥n a PDF no implementada.');
    }
  </script>

  <script src="js/cerrarSesion.js"></script>
</body>
</html>
