<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generación y Exportación de Reportes</title>
  <link rel="stylesheet" href="reporte.css">
  <!-- Incluimos Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Scripts para exportar a CSV y PDF -->
  <!-- Bibliotecas para esto-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</head>
<body>
  <aside class="menu-lateral">
    <h2>Menú</h2>
    <nav>
      <ul>
        <li><a href="dashboard.html" ><span>🏠</span> Inicio</a></li>
        <li><a href="reporte.html"  class="active"><span>📄</span> Reportes</a></li>
        <li><a href="incidentes.html"><span>🚨</span> Incidentes</a></li>
        <li><a href="usuarios.html"><span>👥</span> Usuarios</a></li>
        <li><a href="admin-entidades.html"><span>🏢</span> Agregar</a></li> 
        <li><a href="configuracion.html"><span>⚙️</span> Configuración</a></li>
        <li><a href="#" id="cerrar-sesion"><span>🔒</span> Cerrar sesión</a></li>
        
      </ul>
    </nav>
  </aside>

  <div class="container">
    <header>
      <h1>Generación y Exportación de Reportes</h1>
      <p>Filtra, exporta y analiza los incidentes para tomar decisiones informadas.</p>
    </header>
    
    <div id="selectorFiltros">

    </div>

  <!-- Sección de Exportación de Datos -->
    <section class="exportacion">
      <h2>Exportación de Datos</h2>
      <p>Descarga los reportes en formatos CSV o PDF para análisis externos o reuniones.</p>
      <div class="botones-exportacion">
        <button id="export-csv">Exportar CSV</button>
        <button id="export-pdf">Exportar PDF</button>
      </div>
    </section>
    </section>

    <!-- Sección de Estadísticas Avanzadas -->
    <section class="estadisticas-avanzadas">
      <h2>Estadísticas Avanzadas</h2>
      <p>Visualiza tendencias por hora, día y ubicación, y realiza comparativas entre periodos.</p>
      <div class="graficos">
        <!-- Aquí insertamos nuestra gráfica de barras -->
        <div class="grafico">
          <canvas id="porBano" width="600" height="400"></canvas>
        </div>
        <div class="grafico" id="grafico-comparativo">
          <canvas id="porFecha" width="600" height="400"></canvas>
        </div>
        <div class="grafico" id="grafico-comparativo">
          <canvas id="porIncidente" width="600" height="400"></canvas>
        </div>
      </div>
    </section>
  </div>

  <script>
    if(!localStorage.getItem('authToken')){
      window.location.href = "login.html"
    }
  </script>

  <!-- Scripts para inicializar la paguina y graficas-->
  <script type="module">
    import { obtenerSectionFiltro, ejecutarObtencionFiltrada, obtenerIncidentesAPI, agregarVerificacionFiltros } from './js/filtro.js';

    async function inicializarPaguina(){
      // Obtener datos de la API o de un array estático

      // filtrado
      const sectionFiltro = document.getElementById('selectorFiltros');
      sectionFiltro.innerHTML = await obtenerSectionFiltro();
      agregarVerificacionFiltros();
      document.getElementById('form-filtros').addEventListener('submit', () => {
        event.preventDefault();
        filtrar()
      })


      let datosAPI;
      try {
        datosAPI = await obtenerIncidentesAPI({});
        if (datosAPI == {}) {
          return
        }
      } catch (error) {
        console.error('Error al obtener los datos de la API:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al cargar los datos',
          text: 'No se pudieron obtener los incidentes. Por favor, inténtalo de nuevo más tarde.'
        }); 
      }

      // Generar graficas
      try {
        await generarGraficas(datosAPI);
      } catch (error) {
        console.error('Error al generar las gráficas:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al generar las gráficas',
          text: 'No se pudieron generar las gráficas. Por favor, inténtalo de nuevo más tarde.'
        });
      }
    }
    
    async function generarGraficas(datosAPI, filtros = {}) {
      // crear datos que utilizaremos para graficas
      const { porBano, porFecha, porIncidente } = procesarDatosParaGraficas(datosAPI);

      // Limpiar canvas antes de generar nuevas gráficas
      if (!window.charts) {
        window.charts = {};
      }
      
      // Generar gráficas
      window.charts['porBano']?.destroy();
      window.charts['porBano'] = await generarGrafica('porBano', Object.keys(porBano), Object.values(porBano), 'Incidentes por Baño');

      window.charts['porFecha']?.destroy();
      window.charts['porFecha'] = await generarGrafica('porFecha', Object.keys(porFecha), Object.values(porFecha), 'Incidentes por Fecha');

      window.charts['porIncidente']?.destroy();
      window.charts['porIncidente'] = await generarGrafica('porIncidente', Object.keys(porIncidente), Object.values(porIncidente), 'Incidentes por Tipo');

    }

    async function generarGrafica(canvasId, etiquetas, valores, titulo) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [{
            label: titulo,
            data: valores,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });
    }

    function procesarDatosParaGraficas(datos){
      const porBano = {};
      const porFecha = {};
      const porIncidente = {};

      datos.forEach(reporte => {
        // Contar por baño
        const edificio = reporte.bano.edificio.nombre;
        const genero = reporte.bano.genero;
        const clave = `Edificio ${edificio} - ${genero}`;
        porBano[clave] = (porBano[clave] || 0) + 1;

        // Contar por fecha (solo fecha sin hora)
        const fecha = reporte.fecha_reporte.split(' ')[0];
        porFecha[fecha] = (porFecha[fecha] || 0) + 1;

        // Contar por tipo de incidente
        const tipoIncidente = reporte.incidente.nombre;
        porIncidente[tipoIncidente] = (porIncidente[tipoIncidente] || 0) + 1;
      });

      return { porBano, porFecha, porIncidente };
    }

    async function filtrar(){

      const datos = await ejecutarObtencionFiltrada(); 
      console.log('Datos filtrados:', datos);

      if (datos.length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'No hay datos disponibles',
          text: 'No se encontraron incidentes con los filtros aplicados.'
        });
        return ;
      }
      
      if (Object.keys(datos).length === 0) {
        Swal.fire({
          icon: 'info',
          title: 'No hay datos disponibles',
          text: 'No se encontraron incidentes con los filtros aplicados.'
        });
        return;
      }

      // realizar el resto con estos datos
      await generarGraficas(datos);

      return datos;
    };

    // Al cargar la página, generamos la gráfica
    window.addEventListener('DOMContentLoaded', () => {
      inicializarPaguina();
    });

  document.getElementById('export-pdf').addEventListener('click', exportarPDF);
  document.getElementById('export-csv').addEventListener('click', exportarCSV);

  // Funcion para exportar a PDF
  async function exportarPDF() {
    const { jsPDF } = window.jspdf;
    // obtener los datos filtrados
    //const datosBrutos = await filtrar()
    const datosBrutos = await ejecutarObtencionFiltrada();

    await generarGraficas(datosBrutos);
    // Verifica que hay datos
    if (!datosBrutos || datosBrutos.length === 0) {
      alert("No hay datos para exportar.");
      return;
    }

    // transformar los datos a un formato adecuado para la tabla
    const datos = datosBrutos.map(dato => ({
      ID: dato.id_reporte,
      Incidente: dato.incidente?.nombre || "",
      Descripción: dato.descripcion,
      Estado: dato.estado,
      Prioridad: dato.prioridad,
      "Fecha Reporte": dato.fecha_reporte,
      Baño: `Edificio ${dato.bano?.edificio?.nombre || ""} - Planta ${dato.bano?.edificio?.planta || ""} - ${dato.bano?.genero || ""}`
    }));

    // Crear una instancia de jsPDF
    const doc = new jsPDF();

    // Generar la tabla con autoTable
    const columnas = Object.keys(datos[0]).map(key => ({ header: key, dataKey: key }));
    doc.autoTable({
      head: [columnas.map(col => col.header)],
      body: datos.map(fila => columnas.map(col => fila[col.dataKey])),
      startY: 10,
      styles: { fontSize: 8 },
      headStyles: { fillColor: [22, 160, 133] },
    });

    let posY = doc.autoTable.previous.finalY + 10;

    // Agregar gráficos
    // Timeout por que las gráficas necesitan tiempo para renderizarse, si no estan vacias
    setTimeout(() => {
      const canvasIds = ["porBano", "porFecha", "porIncidente"];
      for (const id of canvasIds) {
        const canvas = document.getElementById(id);
        if (canvas) {
          const imgData = canvas.toDataURL("image/png", 1.0);
          doc.addImage(imgData, "PNG", 10, posY, 180, 80);
          posY += 90;

          // Si se pasa del límite de página, crear una nueva
          if (posY + 90 > doc.internal.pageSize.getHeight()) {
            doc.addPage();
            posY = 10;
          }
        }
      }
      
      // 5. Guardar PDF
      doc.save("reporte.pdf");
  }, 200);
  }
  
  async function exportarCSV() {
    const datosBrutos = await ejecutarObtencionFiltrada();

    if (!datosBrutos || datosBrutos.length === 0) {
      alert("No hay datos para exportar.");
      return;
    }

    // 1. Transformar los datos igual que en PDF
    const datos = datosBrutos.map(dato => ({
      ID: dato.id_reporte,
      Incidente: dato.incidente?.nombre || "",
      Descripción: dato.descripcion,
      Estado: dato.estado,
      Prioridad: dato.prioridad,
      "Fecha Reporte": dato.fecha_reporte,
      Baño: `Edificio ${dato.bano?.edificio?.nombre || ""} - Planta ${dato.bano?.edificio?.planta || ""} - ${dato.bano?.genero || ""}`
    }));

    // 2. Crear contenido CSV
    const columnas = Object.keys(datos[0]);
    const encabezados = columnas.join(",");
    const filas = datos.map(fila => 
      columnas.map(col => `"${(fila[col] || "").toString().replace(/"/g, '""')}"`).join(",")
    );
    const contenido = [encabezados, ...filas].join("\n");

    // 3. Descargar CSV
    const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "reporte.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  </script>
  

  <script src="js/cerrarSesion.js"></script>
</body>
</html>
