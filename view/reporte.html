<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generación y Exportación de Reportes</title>
  <link rel="stylesheet" href="reporte.css">
  <!-- Incluimos Chart.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>
<body>
  <aside class="menu-lateral">
    <h2>Menú</h2>
    <nav>
      <ul>
        <li><a href="dashboard.html" ><span>🏠</span> Inicio</a></li>
        <li><a href="reporte.html"  class="active"><span>📄</span> Reportes</a></li>
        <li><a href="incidentes.html"><span>🚨</span> Incidentes</a></li>
        <li><a href="usuarios.html"><span>👥</span> Usuarios</a></li>
        <li><a href="admin-entidades.html"><span>🏢</span> Agregar</a></li> 
        <li><a href="configuracion.html"><span>⚙️</span> Configuración</a></li>
        <li><a href="#" id="cerrar-sesion"><span>🔒</span> Cerrar sesión</a></li>
        
      </ul>
    </nav>
  </aside>

  <div class="container">
    <header>
      <h1>Generación y Exportación de Reportes</h1>
      <p>Filtra, exporta y analiza los incidentes para tomar decisiones informadas.</p>
    </header>
    
    <section class="filtros-avanzados">
      <h2>Filtros Avanzados</h2>
      <form id="form-filtros">
        <div class="campo">
          <label for="fecha-inicio">Fecha Inicio:</label>
          <input type="date" id="fecha-inicio" name="fecha-inicio">
        </div>
        <div class="campo">
          <label for="fecha-fin">Fecha Fin:</label>
          <input type="date" id="fecha-fin" name="fecha-fin">
        </div>
        <div class="campo">
          <label for="ubicacion">Ubicación:</label>
          <select id="ubicacion" name="ubicacion">
            <option value="">Todas</option>
            <!-- Más opciones según necesidad -->
          </select>
        </div>
        <div class="campo">
          <label for="estado">Estado:</label>
          <select id="estado" name="estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en-proceso">En Proceso</option>
            <option value="resuelto">Resuelto</option>
          </select>
        </div>
        <button type="submit">Aplicar Filtros</button>
      </form>
    </section>

  <!-- Sección de Exportación de Datos -->
    <section class="exportacion">
      <h2>Exportación de Datos</h2>
      <p>Descarga los reportes en formatos CSV o PDF para análisis externos o reuniones.</p>
      <div class="botones-exportacion">
        <button id="export-csv">Exportar CSV</button>
        <button id="export-pdf">Exportar PDF</button>
      </div>
    </section>
    </section>

    <!-- Sección de Estadísticas Avanzadas -->
    <section class="estadisticas-avanzadas">
      <h2>Estadísticas Avanzadas</h2>
      <p>Visualiza tendencias por hora, día y ubicación, y realiza comparativas entre periodos.</p>
      <div class="graficos">
        <!-- Aquí insertamos nuestra gráfica de barras -->
        <div class="grafico">
          <canvas id="porBano" width="600" height="400"></canvas>
        </div>
        <div class="grafico" id="grafico-comparativo">
          <canvas id="porFecha" width="600" height="400"></canvas>
        </div>
        <div class="grafico" id="grafico-comparativo">
          <canvas id="porIncidente" width="600" height="400"></canvas>
        </div>
      </div>
    </section>
  </div>

  <script>
    if(!localStorage.getItem('authToken')){
      window.location.href = "login.html"
    }
  </script>

  <!-- Scripts para inicializar la paguina y graficas-->
  <script>

    async function inicializarPaguina(){
      // Obtener datos de la API o de un array estático
      let datosAPI;
      try {
        datosAPI = await obtenerIncidentesAPI({});
        if (datosAPI == {}) {
          return
        }
      } catch (error) {
        console.error('Error al obtener los datos de la API:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al cargar los datos',
          text: 'No se pudieron obtener los incidentes. Por favor, inténtalo de nuevo más tarde.'
        }); 
      }

      // Generar graficas
      try {
        generarGraficas(datosAPI);
      } catch (error) {
        console.error('Error al generar las gráficas:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error al generar las gráficas',
          text: 'No se pudieron generar las gráficas. Por favor, inténtalo de nuevo más tarde.'
        });
      }
    }

    async function obtenerIncidentesAPI(filtros = {}){
      const queryParams = new URLSearchParams(filtros).toString();
      const url = `http://localhost:1234/incidentes${queryParams ? '?' + queryParams : ''}`;
      console.log('URL de la API:', url);
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Error en la solicitud: ' + response.status);
        }
        const temp = await response.json();
        const data = temp.datos
        if (data.length === 0) {
          Swal.fire({
            icon: 'info',
            title: 'No hay datos disponibles',
            text: 'No se encontraron incidentes con los filtros aplicados.'
          });
          return {};
        }
        incidentesAPI = data; // Variable global
        return incidentesAPI;
      } catch (error) {
        console.error('Error al obtener los datos:', error);
        throw error;
      }
    }
    
    async function generarGraficas(datosAPI){
      // crear datos que utilizaremos para graficas
      const { porBano, porFecha, porIncidente } = procesarDatosParaGraficas(datosAPI);

      generarGrafica('porBano', Object.keys(porBano), Object.values(porBano), 'Incidentes por Baño');
      generarGrafica('porFecha', Object.keys(porFecha), Object.values(porFecha), 'Incidentes por Fecha');
      generarGrafica('porIncidente', Object.keys(porIncidente), Object.values(porIncidente), 'Incidentes por Tipo');

    }

    function generarGrafica(canvasId, etiquetas, valores, titulo) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [{
            label: titulo,
            data: valores,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    function procesarDatosParaGraficas(datos){
      const porBano = {};
      const porFecha = {};
      const porIncidente = {};

      datos.forEach(reporte => {
        // Contar por baño
        const edificio = reporte.bano.edificio.nombre;
        const genero = reporte.bano.genero;
        const clave = `Edificio ${edificio} - ${genero}`;
        porBano[clave] = (porBano[clave] || 0) + 1;

        // Contar por fecha (solo fecha sin hora)
        const fecha = reporte.fecha_reporte.split(' ')[0];
        porFecha[fecha] = (porFecha[fecha] || 0) + 1;

        // Contar por tipo de incidente
        const tipoIncidente = reporte.incidente.nombre;
        porIncidente[tipoIncidente] = (porIncidente[tipoIncidente] || 0) + 1;
      });

      return { porBano, porFecha, porIncidente };
    }

    // Al cargar la página, generamos la gráfica
    window.addEventListener('DOMContentLoaded', () => {
      inicializarPaguina();
    });

    // Agregar ubicaciones de banos a la lista de filtros
    document.addEventListener('DOMContentLoaded', function () {
    const select = document.getElementById('ubicacion');

    fetch('http://localhost:1234/banios')
      .then(response => response.json())
      .then(data => {
        const ubicacionesUnicas = new Set();

        data.forEach(banio => {
          if (banio.ubicacion) {
            ubicacionesUnicas.add(`${banio.ubicacion}`);
          }
        });

        // Agregar cada ubicación como opción
        ubicacionesUnicas.forEach(ubicacion => {
          const option = document.createElement('option');
          option.value = ubicacion;
          option.textContent = ubicacion;
          select.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error al obtener las ubicaciones:', error);
      });
  });

  </script>

  <!-- Script para el filtro-->
  <script> 
    document.getElementById('form-filtros').addEventListener('submit', async function(event) {
      event.preventDefault(); // Evita el envío del formulario

      // Obtener los valores de los filtros
      const fechaInicio = document.getElementById('fecha-inicio').value;
      const fechaFin = document.getElementById('fecha-fin').value;
      const ubicacion = document.getElementById('ubicacion').value;
      const estado = document.getElementById('estado').value;

      // Crear un objeto con los filtros
      const filtros = {
        'fecha_inicio': fechaInicio,
        'fecha_fin': fechaFin,
        'edificio': ubicacion.split(' planta ')[0], 
        'planta': ubicacion.split(' planta ')[1] || '',
        'estado': estado
      };

      // Obtener los datos filtrados de la API
      const datos = await obtenerIncidentesAPI(filtros)

      console.log('Datos filtrados:', datos, filtros);
    });
  </script>

  <!-- Scripts para exportar a CSV y PDF -->
  <script >
    document.getElementById('export-pdf').addEventListener('click', exportarPDF);

    // Funcion para exportar a PDF
    function exportarPDF() {
      // Aquí iría la lógica para exportar a PDF
      alert('Función de exportación a PDF no implementada.');
    }
    
  </script>

  

  <script src="js/cerrarSesion.js"></script>
</body>
</html>
