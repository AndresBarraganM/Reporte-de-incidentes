<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Reporte</title>
    <link rel="stylesheet" href="form_reporte.css"> <!-- Enlaza el archivo CSS -->
</head>

<script>
    // direccion del servidor
    const serverUrl = 'http://localhost:1234/';
</script>

<body>

    <div class="contenedor">
        <h2>Formulario de Reporte</h2>

        <p class="descripcion-formulario">
            Este formulario permite reportar incidentes ocurridos en los baños de la institución, 
            como problemas de limpieza, daños en las instalaciones o falta de suministros. 
            Por favor completa todos los campos y, si es posible, adjunta una fotografía del incidente.
        </p>

        <form id="reporteForm">
            <label for="ubicacion">Ubicación:</label>
            <select id="ubicacion" name="ubicacion" required>
                <option value="" disabled selected>Seleccione una ubicación</option>
            </select>

            <!-- Botón de selección de archivo personalizado -->
            <label for="foto">Subir foto:</label>
            <div class="file-input-container">
                <input type="file" id="foto" name="foto" accept="image/*">
                <label for="foto" class="file-label">Seleccionar archivo</label>
                <span class="file-name">Ningún archivo seleccionado</span>
            </div>

            <label for="baño">Baño:</label>
            <select id="baño" name="baño" required>
                <option value="" disabled selected>Seleccione un baño</option>
                <option value="hombre">Baño Hombre</option>
                <option value="mujer">Baño Mujer</option>
            </select>

            <label for="incidente">Tipo de Incidente:</label>
                <select id="incidente" name="incidente" required>

                </select>
            <label for="descripcion">Descripción:</label>
            <textarea id="descripcion" name="descripcion" rows="4" required></textarea>

 

            <input type="submit" value="Enviar Reporte">
        </form>
    </div>

    <script>
        // JavaScript para mostrar el nombre del archivo seleccionado
        document.getElementById('foto').addEventListener('change', function (e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : "Ningún archivo seleccionado";
            document.querySelector('.file-name').textContent = fileName;
        });
    </script>

    <script>
        // JavaScript para cargar los datos de los baños y ubicaciones
        // y habilitar/deshabilitar genero si existe en la ubicacion seleccionada
        let datosBanos = [];

        const ubicacionSelect = document.getElementById('ubicacion');
        const banoSelect = document.getElementById('baño');

        fetch(serverUrl+'banos')
            .then(response => response.json())
            .then(data => {
                datosBanos = data;

                // Rellenar ubicaciones únicas
                const ubicacionesUnicas = new Set();
                data.forEach(item => {
                    if (!ubicacionesUnicas.has(item.ubicacion)) {
                        ubicacionesUnicas.add(item.ubicacion);
                        const option = document.createElement('option');
                        option.value = item.ubicacion;
                        option.textContent = item.ubicacion;
                        ubicacionSelect.appendChild(option);
                    }
                });
            })
            .catch(error => {
                console.error('Error al obtener los baños:', error);
            });

        ubicacionSelect.addEventListener('change', () => {
            const ubicacionSeleccionada = ubicacionSelect.value;

            // Verificar qué géneros están disponibles en esta ubicación
            const generosDisponibles = new Set(
                datosBanos
                    .filter(item => item.ubicacion === ubicacionSeleccionada)
                    .map(item => item.genero_bano)
            );

            // Habilitar o deshabilitar opciones en el select de baño
            let seleccionValida = false;
            for (const option of banoSelect.options) {
                if (option.value === "") continue; // ignorar el default

                if (generosDisponibles.has(option.value)) {
                    option.disabled = false;
                    if (option.selected) seleccionValida = true;
                } else {
                    option.disabled = true;
                }
            }

            // Si el género actual no es válido, volver al default
            if (!seleccionValida) {
                banoSelect.value = "";
            }
        });
    </script>

    <script> 
        const incidenteSelect = document.getElementById('incidente');

        fetch(serverUrl+'tipos_incidentes')
            .then(response => response.json())
            .then(data => {
                // Rellenar el select con los tipos de incidentes
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.nombre;
                    option.textContent = item.nombre;
                    incidenteSelect.appendChild(option);
                });
            }).catch(error => {
                console.error('Error al obtener los tipos de incidentes:', error);
            });
    </script>

    <script>
    document.getElementById('reporteForm').addEventListener('submit', async function(e) {
        e.preventDefault();
    
        const ubicacion = document.getElementById('ubicacion').value;
        const genero = document.getElementById('baño').value;
        const tipo = document.getElementById('incidente').value;
        const descripcion = document.getElementById('descripcion').value;
        const fotoInput = document.getElementById('foto');
        const foto = fotoInput.files[0];
    
        const formData = new FormData();
        console.log(formData)
    
        // Adjuntar campo "data" como JSON
        const json = {
            ubicacion: ubicacion,
            genero_bano: genero,
            tipo_incidente: tipo,
            descripcion: descripcion
        };
        //const blob = new Blob([JSON.stringify(json)], { type: 'application/json' });
        formData.append('data', JSON.stringify(json));
    
        // Adjuntar imagen
        if (foto) {
        formData.append('foto', foto);
        }
    
        try {
            const response = await fetch(serverUrl+'incidentes', {
                method: 'POST',
                body: formData
            });
    
            if (response.ok) {
                alert('Reporte enviado con éxito');
                // Opcional: resetear formulario
                e.target.reset();
            } else {
                const errorText = await response.text();
                alert('Error al enviar reporte:\n' + errorText);
            }
        } catch (err) {
            console.error('Error:', err);
            alert('Error al conectar con el servidor');
        }
    });
    </script>
</body>
</html>