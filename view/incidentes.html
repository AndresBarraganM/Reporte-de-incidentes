<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Incidentes</title>
  <link rel="stylesheet" href="incidentes.css">
</head>
<body>
  <aside class="menu-lateral">
    <h2>Men√∫</h2>
    <nav>
      <ul>
        <li><a href="dashboard.html" ><span>üè†</span> Inicio</a></li>
          <li><a href="reporte.html"><span>üìÑ</span> Reportes</a></li>
          <li><a href="incidentes.html" class="active"><span>üö®</span> Incidentes</a></li>
          <li><a href="usuarios.html"><span>üë•</span> Usuarios</a></li>
          <li><a href="configuracion.html"><span>‚öôÔ∏è</span> Configuraci√≥n</a></li>
      </ul>
    </nav>
  </aside>

  <div class="container">
    <header>
      <h1>Gesti√≥n de Incidentes</h1>
    </header>

    <section class="filtros">
      <h2>Filtrar incidentes</h2>
      <form id="filtro-incidentes">
        <div class="campo">
          <label for="fecha">Fecha:</label>
          <input type="date" id="fecha" name="fecha">
        </div>
        <div class="campo">
          <label for="banio">Ba√±o:</label>
          <select id="banio" name="banio">
            <option value="">Todos</option>
            <option value="banio1">Ba√±o 1</option>
            <option value="banio2">Ba√±o 2</option>
          </select>
        </div>
        <div class="campo">
          <label for="estado">Estado:</label>
          <select id="estado" name="estado">
            <option value="">Todos</option>
            <option value="pendiente">Pendiente</option>
            <option value="en-proceso">En proceso</option>
            <option value="resuelto">Resuelto</option>
          </select>
        </div>
        <div class="campo">
          <label for="prioridad">Prioridad:</label>
          <select id="prioridad" name="prioridad">
            <option value="">Todos</option>
            <option value="alta">Alta</option>
            <option value="media">Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
        <button type="submit">Filtrar</button>
      </form>
    </section>

    <section class="listado">
      <h2>Listado de Incidentes</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Ubicacion</th>
            <th>Tipo de incidente</th>
            <th>Fecha / Hora</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-incidentes-body">
          
        </tbody>
      </table>
    </section>

  </div>

  <!-- MODAL de detalle -->
<div id="modal-detalle" class="modal">
  <div class="modal-contenido">
    <span class="cerrar" id="cerrar-modal">&times;</span>
    <h2>Detalle del Incidente</h2>
    <p><strong>ID:</strong> <span id="detalle-id"></span></p>
    <p><strong>Ubicaci√≥n:</strong> <span id="detalle-ubicacion"></span></p>
    <p><strong>Tipo de Incidente:</strong> <span id="detalle-tipo"></span></p>
    <p><strong>Descripci√≥n:</strong> <span id="detalle-descripcion"></span></p>
    <p><strong>Fecha/Hora:</strong> <span id="detalle-fecha"></span></p>
    <p><strong>Prioridad:</strong> <span id="detalle-prioridad"></span></p>
    <p><strong>Estado:</strong> <span id="detalle-estado"></span></p>
    
  </div>
  

</div>


  <script>
  async function cargarIncidentes(filtros = {}) {
  const params = new URLSearchParams();

  if (filtros.fecha) params.append('fechaDespuesDe', filtros.fecha);
  if (filtros.banio) params.append('banio', filtros.banio);
  if (filtros.estado) params.append('estado', filtros.estado);
  if (filtros.prioridad) params.append('prioridad', filtros.prioridad);

  try {
    const response = await fetch(`http://localhost:1234/incidentes?${params.toString()}`);
    if (!response.ok) throw new Error('Error al obtener incidentes');

    const incidentes = await response.json();
    const tbody = document.getElementById('tabla-incidentes-body');
    tbody.innerHTML = '';

    incidentes.forEach(incidente => {
      const tr = document.createElement('tr');
      const detalleString = encodeURIComponent(JSON.stringify(incidente));

      tr.innerHTML = `
        <td>${incidente.id_reporte}</td>
        <td>${incidente.bano.edificio.nombre} - Planta: ${incidente.bano.edificio.planta} - Ba√±o: ${incidente.bano.genero}</td>
        <td>${incidente.incidente.nombre}</td>
        <td>${new Date(incidente.fecha_reporte).toLocaleString()}</td>
        <td>${incidente.prioridad}</td>
        <td>${incidente.estado}</td>
        <td>
          <div class="dropdown">
            <button class="dropbtn">Acciones</button>
            <div class="dropdown-content">
              <a href="#" class="ver-detalle" data-detalle="${detalleString}">Ver Detalle</a>
              <a href="#" data-estado="en-proceso">Marcar como En Proceso</a>
              <a href="#" data-estado="resuelto">Marcar como Resuelto</a>
              <a href="#" data-estado="pendiente">Marcar como Pendiente</a>
            </div>
          </div>
        </td>
      `;

      tbody.appendChild(tr);
    });

    // ‚Üê‚Üì‚Üì SE AGREGA ESTE EVENTO DESPU√âS DE LLENAR LA TABLA
    tbody.querySelectorAll('.ver-detalle').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();

        const detalle = JSON.parse(decodeURIComponent(btn.dataset.detalle));

        document.getElementById('detalle-id').textContent = detalle.id_reporte;
        document.getElementById('detalle-ubicacion').textContent = `${detalle.bano.edificio.nombre} - Planta ${detalle.bano.edificio.planta} - Ba√±o ${detalle.bano.genero}`;
        document.getElementById('detalle-tipo').textContent = detalle.incidente.nombre;
        document.getElementById('detalle-descripcion').textContent = detalle.descripcion;
        document.getElementById('detalle-fecha').textContent = new Date(detalle.fecha_reporte).toLocaleString();
        document.getElementById('detalle-prioridad').textContent = detalle.prioridad;
        document.getElementById('detalle-estado').textContent = detalle.estado;

        document.getElementById('modal-detalle').style.display = 'block';
      });
    });

  } catch (error) {
    console.error(error);
    alert('Error cargando los incidentes');
  }
}


  // Cargar incidentes al cargar la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    cargarIncidentes();

    // Agregar evento al formulario de filtro
    document.getElementById('filtro-incidentes').addEventListener('submit', (e) => {
      e.preventDefault();

      const filtros = {
        fecha: document.getElementById('fecha').value,
        banio: document.getElementById('banio').value,
        estado: document.getElementById('estado').value,
        prioridad: document.getElementById('prioridad').value,
      };

      cargarIncidentes(filtros);
    });
  });

document.getElementById('cerrar-modal').addEventListener('click', () => {
  document.getElementById('modal-detalle').style.display = 'none';
});


</script>


</body>
</html>

